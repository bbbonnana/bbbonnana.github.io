<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>互联网协议</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.47ef6698.js" as="script"><link rel="preload" href="/assets/js/2.6d8ae55b.js" as="script"><link rel="preload" href="/assets/js/3.924945c2.js" as="script"><link rel="prefetch" href="/assets/js/10.f387a10f.js"><link rel="prefetch" href="/assets/js/11.c1b4cb0b.js"><link rel="prefetch" href="/assets/js/12.5c9e598e.js"><link rel="prefetch" href="/assets/js/13.537bc5a1.js"><link rel="prefetch" href="/assets/js/14.9ede1c62.js"><link rel="prefetch" href="/assets/js/15.a28880a7.js"><link rel="prefetch" href="/assets/js/16.5466c073.js"><link rel="prefetch" href="/assets/js/17.65bdf248.js"><link rel="prefetch" href="/assets/js/4.5fa47ea8.js"><link rel="prefetch" href="/assets/js/5.26e38a66.js"><link rel="prefetch" href="/assets/js/6.adbc6dbc.js"><link rel="prefetch" href="/assets/js/7.d1d73f47.js"><link rel="prefetch" href="/assets/js/8.2b10522a.js"><link rel="prefetch" href="/assets/js/9.87a41797.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">前端小记</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>端外基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basis/protocol/" aria-current="page" class="active sidebar-link">互联网协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/basis/protocol/#tcp" class="sidebar-link">TCP</a></li><li class="sidebar-sub-header"><a href="/basis/protocol/#http-1-x-2-0" class="sidebar-link">HTTP 1.x &amp; 2.0</a></li><li class="sidebar-sub-header"><a href="/basis/protocol/#https" class="sidebar-link">HTTPS</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>核心前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>HTML &amp; CSS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/core/html-css/basis/" class="sidebar-link">样式基础</a></li><li><a href="/core/html-css/css3/" class="sidebar-link">CSS3</a></li><li><a href="/core/html-css/layout/" class="sidebar-link">常见布局</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/build/webpack/" class="sidebar-link">Webpack原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/framework/vue/source/" class="sidebar-link">VUE2 源码分析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-js/server/http/" class="sidebar-link">Node.js中搭建HTTP服务器</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="互联网协议"><a href="#互联网协议" class="header-anchor">#</a> 互联网协议</h1> <h2 id="tcp"><a href="#tcp" class="header-anchor">#</a> TCP</h2> <p>TCP是一种面向连接的、可靠的、基于字节流的传输层通信协议。</p> <h3 id="报文头部"><a href="#报文头部" class="header-anchor">#</a> 报文头部</h3> <p><img src="/assets/img/tcp-header.e6924a81.png" alt="TCP报文头部"></p> <p>在建立TCP连接之初，序列号被系统初始化为一个随机值<strong>ISN</strong>（后文例图中为x）。</p> <p><strong>一个报文的序列号 = ISN + 该报文携带数据的第一个字节的偏移量</strong>；</p> <p><strong>一个报文的确认号 = 发送报文方期待接收到的下一个报文序列号</strong>。</p> <h3 id="三次握手"><a href="#三次握手" class="header-anchor">#</a> 三次握手</h3> <p><img src="/assets/img/handshake.39f408fe.png" alt="三次握手"></p> <ul><li><p>第一次握手</p> <p>客户端要向服务端发起连接请求，首先先随机生成一个起始序列号ISN(比如是x)，且发送的报文段SYN标志位置为1。</p></li> <li><p>第二次握手</p> <p>服务端收到SYN=1报文后，知道这是一个连接请求**（SYN标志位只有在TCP建立连接时才会被置为1）<strong>，于是将客户端的ISN即x存起来，并随机生成服务端的起始序列号y后回复如图所示报文</strong>（ACK=1表示确认号是有效的，携带ACK标志的报文段也称确认报文段）**。</p></li> <li><p>第三次握手</p> <p>客户端收到回复后发现ACK=1且ack=x+1，于是知道服务端已经收到序列号x的报文，同时发现SYN=1，知道服务端同意了本次连接，便将服务端的序列号y存下来再回复图中所示序列号为x+1的报文。当服务端收到报文后发现ACK=1且ack=y+1，就这样客户端和服务端通过TCP建立了连接。</p> <p><strong>需要注意的是不携带数据的ACK报文是不占据序列号的，所以后面第一次正式发送数据时seq还是x+1)</strong></p></li></ul> <h3 id="四次挥手"><a href="#四次挥手" class="header-anchor">#</a> 四次挥手</h3> <p><img src="/assets/img/disconnect.bfd98cbe.png" alt="四次挥手"></p> <p>假设TCP连接成功后客户端共发送了1000个字节数据，服务端在客户端发FIN报文前共回复了2000个字节的数据。</p> <ul><li><p>第一次挥手</p> <p>当客户端的数据传输完成后发送连接释放报文（当然数据没发完时也可以发送），报文包含FIN标志位为1、序列号seq=x+1+1000。需注意客户端发出FIN报文段后只是不能发数据了，但是还可以正常收数据；另外FIN报文段即使不携带数据也要占一个序列号。</p></li> <li><p>第二次挥手</p> <p>服务端收到FIN报文后以ACK=1，seq=y+2000，ack=x+1+1000+1返回报文， 此时服务端处于关闭等待状态，但不是立马给客户端发FIN报文，因为服务端可能还有数据没发完。</p></li> <li><p>第三次握手</p> <p>数据传送完毕后，服务端发送FIN报文，如图所示。</p></li> <li><p>第四次挥手</p> <p>客户端收到FIN报文并回复确认报文，注意发出确认报文后不是立马释放TCP连接，而是要经过2MSL（最长报文段寿命的2倍时长）</p></li></ul> <h3 id="问答"><a href="#问答" class="header-anchor">#</a> 问答</h3> <p><strong>为什么TCP连接的时候是3次？2次不可以吗？</strong></p> <p>如果只握手2次，如果第二次握手时服务端发给客户端的确认报文段丢失，此时服务端已经准备好了收发数据，而客户端一直没收到确认报文，所以客户端就不知道服务端是否已经准备好了，这种情况下客户端不会给服务端发数据，也会忽略服务端发过来的数据。</p> <p><strong>为什么TCP连接的时候是3次，关闭的时候却是4次？</strong></p> <p>因为客户端发FIN报文时只能保证客户端没有数据发而不能保证服务端数据发送完毕，因此服务端收到FIN报文后只能先回复一个确认报文，等数据发完了才能回复客户端FIN报文。</p> <p><strong>如果已经建立了连接，但是客户端突然出现故障了怎么办？</strong></p> <p>TCP设有一个保活计时器，客户端如果出现故障，服务器不能一直白等。服务器每收到一次客户端请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。</p> <h2 id="http-1-x-2-0"><a href="#http-1-x-2-0" class="header-anchor">#</a> HTTP 1.x &amp; 2.0</h2> <h3 id="http-1-0"><a href="#http-1-0" class="header-anchor">#</a> HTTP 1.0</h3> <p>HTTP 1.0 默认不支持长连接，其所保持的TCP连接只能处理一个请求，在请求量多的情况下TCP连接数也会增多且容易造成阻塞</p> <h3 id="http-1-1"><a href="#http-1-1" class="header-anchor">#</a> HTTP 1.1</h3> <p>相比于 HTTP 1.0，在一个 TCP 连接上可以传送多个 HTTP 请求和响应，减少了建立和关闭连接的消耗和延迟。在 HTTP 1.1 中默认开启 “Connection: keep-alive”，一定程度上弥补了 HTTP 1.0 每次请求都要创建连接的缺点。如下图所示短连接与长连接区别：</p> <p><img src="/assets/img/http-connect.351ab4a5.png" alt="短连接与长连接"></p> <p>此外还有以下改进等等：</p> <ul><li>所有HTTP 1.1的响应都包含响应头<code>Date:</code>用于缓存控制</li> <li>请求头引入了 range 头域以允许只请求资源的某个部分</li></ul> <p>缺陷：</p> <ul><li>虽能建立在一个TCP连接上完成多个HTTP请求，但在前面的请求未完成前，后续的请求都在排队等待（即线头阻塞）</li> <li>Header 内容多，而且每次请求 Header 不会变化太多，没有相应的压缩传输优化方案</li></ul> <h3 id="http-2-0"><a href="#http-2-0" class="header-anchor">#</a> HTTP 2.0</h3> <p>相比HTTP 1.1，不同的变化有：</p> <ul><li><p>二进制分帧层</p> <p><img src="/assets/img/http2-frame.c990abfb.png" alt="二进制分帧层"></p> <p>帧是数据传输的最小单位，以二进制传输代替原本的明文传输，原本的报文消息被划分为更小的数据帧，具体到报文上，相比于HTTP 1.1区别如下两图：</p> <p><img src="/assets/img/http1.1-request.9c2b308a.png" alt="http1.1报文"></p> <p><img src="/assets/img/http2-request.7d9b82f0.png" alt="http2报文"></p></li> <li><p>多路复用</p> <p>在一个 TCP 连接上，我们可以向对方不断发送帧，每帧的 stream identifier 的标明这一帧属于哪个流，然后在对方接收时，根据 stream identifier 拼接每个流的所有帧组成一整块数据。把 HTTP/1.1 每个请求都当作一个流，那么多个请求变成多个流，请求响应数据分成多个帧，不同流中的帧交错地发送给对方，这就是 HTTP/2 中的多路复用。</p></li></ul> <p>更多http2.0内容参见 <a href="https://juejin.cn/post/6844903667569541133" target="_blank">掘金博文</a>。</p> <h2 id="https"><a href="#https" class="header-anchor">#</a> HTTPS</h2> <p><img src="/assets/img/https.5f822007.png" alt="https流程"></p> <p>可参考 <a href="https://juejin.cn/post/6844903504046211079" target="_blank">文章1</a> 或 <a href="https://juejin.cn/post/6844903599303032845" target="_blank">文章2</a>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/" class="prev router-link-active">
        前端小记
      </a></span> <span class="next"><a href="/core/html-css/basis/">
        样式基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.47ef6698.js" defer></script><script src="/assets/js/2.6d8ae55b.js" defer></script><script src="/assets/js/3.924945c2.js" defer></script>
  </body>
</html>
